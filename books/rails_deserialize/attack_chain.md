---
title: "攻撃連鎖"
---

これまでの攻撃は直接オブジェクトインジェクションとなるものでしたが、それら以外にも他の攻撃と組み合わせてRCEとなる可能性もあります。


### Directory traversal

Directory traversalは、大きく分けて読み込みの攻撃と書き込みの攻撃の2種類があります。

読み込みのtraversalができる場合は、前述のようにsecret_key_baseなど秘密情報の値を読み出せるとRCEにつなげることが可能です。

書き込みについては、コントローラのファイルなどが上書きされるだけで任意のrubyコードを実行させられるのでRCEとなります。デシリアライズ関連としては、キャッシュファイルがMarshalを使ったものがあれば、細工した内容を書き込んだ後にキャッシュが読み込まれるタイミングでRCEとなることも考えられます。Railsであれば[Bootsnap](https://github.com/Shopify/bootsnap)がキャッシュにMarshalを使用しているため、キャッシュに細工された書き込みがされるとRCEとなります。


### SQL injection

データベース上で値をYAML、Marshalで保存している場合は、SQL injectionでデータが上書きされると、データの読み込み時にオブジェクトインジェクションとなる可能性があります。

SQL injection可能な状態は大変危険です。しかし、ruby側で任意コード実行となるとさらに影響範囲が広がります。他に接続しているデータベースの情報や暗号化しているはずの秘密情報などが漏洩する可能性があります。


### SSRF

SSRF(Server Side Request Forgery)はサーバサイドでの脆弱性で、その名の通り攻撃先のサーバから他のサーバへのリクエストを強制に行うい、インターネットには直接つながらない場所などへ攻撃します。

AWSやGCPのcredentialsが盗まれる事例などが有名ですが、データベースやキャッシュのデータに細工してオブジェクトインジェクションを発生させることも可能です。


#### 事例

https://blog.orange.tw/2017/07/how-i-chained-4-vulnerabilities-on.html

記事の中の4つめがGitHub EnterpriseでSSRFを経由したオブジェクトインジェクションの事例です。RubyからSSRFを使いMemcachedに細工したキャッシュを入れて、更にそのキャッシュをruby側で読み込むとRCEとなったそうです。

現在ではRubyとMemcachedの双方にSSRF対策が入っているため、この問題は再現しないはずです。しかし、SSRFはかなりややこしく実際に安全なのかどうかはシステムの構成も関わってくるため難しい問題です。


